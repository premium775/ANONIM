<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GLASS CHAT // PRIVATE</title>
    <style>
        /* --- GLASSMORPHISM & MOBILE STYLE --- */
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-main: #ffffff;
            --accent: #00d2ff;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; padding: 0;
            font-family: 'Segoe UI', Roboto, sans-serif;
            height: 100vh; overflow: hidden;
            color: var(--text-main);
            background: var(--bg-gradient);
            background-size: 400% 400%;
            animation: gradientMove 15s ease infinite;
            display: flex; justify-content: center; align-items: center;
        }

        @keyframes gradientMove {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Overlay */
        body::before {
            content: ''; position: absolute; top:0; left:0; right:0; bottom:0;
            background: rgba(0,0,0,0.2); backdrop-filter: blur(5px); z-index:0;
        }

        .app-container {
            position: relative; width: 100%; height: 100%; max-width: 500px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            z-index: 10; display: flex; flex-direction: column;
        }

        @media (min-width: 500px) {
            .app-container { height: 90vh; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        }

        /* Screens */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            padding: 30px; background: rgba(0,0,0,0.4); z-index: 20;
            transition: opacity 0.3s;
        }
        .hidden { opacity: 0; pointer-events: none; display: none; }

        h2 { margin-bottom: 20px; font-weight: 300; letter-spacing: 1px; }

        .input-group { width: 100%; margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-size: 12px; opacity: 0.8; }
        
        input {
            width: 100%; padding: 15px; border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.1); color: #fff; font-size: 16px;
            outline: none; transition: 0.3s;
        }
        input:focus { background: rgba(255,255,255,0.2); border-color: var(--accent); }

        button {
            width: 100%; padding: 15px; border-radius: 12px;
            border: none; background: var(--accent); color: #000;
            font-weight: bold; font-size: 16px; cursor: pointer; margin-top: 10px;
        }
        button:active { transform: scale(0.98); }
        .text-btn { background: none; color: #ccc; margin-top: 15px; font-size: 14px; }

        /* Chat Interface */
        #chat-interface { display: flex; flex-direction: column; height: 100%; opacity: 0; transition: opacity 0.5s; }
        #chat-interface.active { opacity: 1; }

        header {
            padding: 15px; background: rgba(0,0,0,0.2); border-bottom: 1px solid var(--glass-border);
            display: flex; justify-content: space-between; align-items: center;
        }

        #group-id-display { font-family: monospace; background: rgba(0,0,0,0.3); padding: 5px 10px; border-radius: 5px; font-size: 12px; }

        #msg-list {
            flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
        }

        /* Message Styles */
        .msg { max-width: 80%; padding: 10px 15px; border-radius: 15px; font-size: 15px; position: relative; animation: popIn 0.3s; }
        @keyframes popIn { from{opacity:0; transform:scale(0.9)} to{opacity:1; transform:scale(1)} }

        .msg.mine { align-self: flex-end; background: rgba(0, 210, 255, 0.3); border-bottom-right-radius: 2px; }
        .msg.others { align-self: flex-start; background: rgba(255,255,255,0.15); border-bottom-left-radius: 2px; }
        
        .msg-meta { font-size: 10px; opacity: 0.6; margin-bottom: 3px; display: block; }
        .msg-time { font-size: 9px; opacity: 0.5; text-align: right; margin-top: 5px; }

        .private-badge {
            font-size: 9px; background: #ff0055; color: white; padding: 2px 5px; border-radius: 4px; margin-left: 5px;
        }

        /* User List (Right Side Overlay) */
        #user-list-panel {
            position: absolute; top: 0; right: 0; width: 70%; height: 100%;
            background: rgba(0,0,0,0.8); backdrop-filter: blur(20px);
            border-left: 1px solid var(--glass-border); z-index: 30;
            transform: translateX(100%); transition: transform 0.3s ease;
            display: flex; flex-direction: column; padding: 20px;
        }
        #user-list-panel.open { transform: translateX(0); }
        
        .user-item {
            padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
            cursor: pointer; display: flex; justify-content: space-between;
        }
        .user-item:active { background: rgba(255,255,255,0.1); }
        .close-btn { position: absolute; top: 15px; right: 15px; font-size: 24px; cursor: pointer; }

        /* Input Area */
        .input-area {
            padding: 10px; background: rgba(0,0,0,0.2);
            border-top: 1px solid var(--glass-border);
            display: flex; gap: 10px; align-items: center;
        }
        .input-area input { flex: 1; padding: 12px; font-size: 14px; }
        
        /* Mode Toggle */
        .mode-indicator {
            font-size: 10px; padding: 5px 10px; border-radius: 10px; background: rgba(255,255,255,0.1);
            margin-right: 10px; text-align: center; max-width: 100px;
        }

    </style>
</head>
<body>

    <div class="app-container">
        
        <!-- 1. REGISTER SCREEN -->
        <div id="register-screen" class="screen">
            <h2>ROYXATDAN O'TISH</h2>
            <div class="input-group">
                <label>ISMINIZ (Yagona bo'lishi kerak)</label>
                <input type="text" id="reg-name" placeholder="Masalan: Jasur">
            </div>
            <div class="input-group">
                <label>PAROL</label>
                <input type="password" id="reg-pass" placeholder="Xavfsiz parol">
            </div>
            <button onclick="register()">SAQLASH</button>
            <button class="text-btn" onclick="showLogin()">Hisobingiz bormi?</button>
        </div>

        <!-- 2. LOGIN SCREEN -->
        <div id="login-screen" class="screen hidden">
            <h2>TIZIMGA KIRISH</h2>
            <div class="input-group">
                <label>ISMINIZ</label>
                <input type="text" id="login-name" placeholder="Ismingizni kiriting">
            </div>
            <div class="input-group">
                <label>PAROL</label>
                <input type="password" id="login-pass" placeholder="Parol">
            </div>
            <button onclick="login()">KIRISH</button>
            <button class="text-btn" onclick="showRegister()">Ro'yxatdan o'tish</button>
        </div>

        <!-- 3. CHAT INTERFACE -->
        <div id="chat-interface">
            <header>
                <div style="display:flex; flex-direction:column;">
                    <span style="font-weight:bold;">Xavfsiz Chat</span>
                    <span id="group-id-display" style="color:var(--accent);">Loading ID...</span>
                </div>
                <button onclick="toggleUserList()" style="width:auto; padding: 8px 15px; font-size:12px; margin:0;">Foydalanuvchilar</button>
            </header>

            <div id="msg-list">
                <!-- Messages -->
            </div>

            <div class="input-area">
                <div id="mode-indicator" class="mode-indicator">Umumiy</div>
                <input type="text" id="msg-input" placeholder="Xabar yozing..." autocomplete="off">
                <button onclick="toggleUserList()" style="width:auto; padding:0 15px; margin:0;">></button>
            </div>
        </div>

        <!-- USER LIST SIDEBAR -->
        <div id="user-list-panel">
            <div class="close-btn" onclick="toggleUserList()">&times;</div>
            <h3 style="margin-top:30px; border-bottom:1px solid #555; padding-bottom:10px;">A'zolar</h3>
            <div id="users-container">
                <!-- Users will be listed here -->
            </div>
            <div style="margin-top:auto; padding:20px; font-size:12px; color:#888;">
                Ism ustiga bosib shaxsiy xabar yuborishingiz mumkin.
            </div>
        </div>

    </div>

    <script>
        /* --- CHAT LOGIC --- */

        // Dastlabki o'rnatish: Random Group ID generatsiya qilish (Bitta dastur uchun)
        // Haqiqiy server bo'lmagani uchun, biz fayl nomi o'rniga LocalStorage'da umumiy kalitdan foydalanamiz.
        // Ikki qurilma bir xil kalitni ishlatishi uchun biz "hardcoded" ID beramiz yoki input orqali.
        
        // Soddalik uchun: Siz kiritgan ID bo'yicha ishlash.
        let GROUP_KEY = "global_chat_v3"; 
        let currentUser = null;
        let messages = [];
        let privateTarget = null; // Kimga yozayotganimiz (null = barchaga)

        window.onload = function() {
            // Brauzer refresh bo'lsa ham login qolishi uchun
            const savedName = localStorage.getItem('glass_chat_last_user');
            if(savedName) {
                document.getElementById('login-name').value = savedName;
            }

            // Sync
            window.addEventListener('storage', (e) => {
                if(e.key === GROUP_KEY) {
                    loadMessages();
                }
            });

            // Enter keys
            document.getElementById('reg-pass').addEventListener('keypress', (e)=>{if(e.key==='Enter') register()});
            document.getElementById('login-pass').addEventListener('keypress', (e)=>{if(e.key==='Enter') login()});
            document.getElementById('msg-input').addEventListener('keypress', (e)=>{if(e.key==='Enter') sendMessage()});
        };

        function showRegister() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('register-screen').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.remove('hidden');
        }

        function getDB() {
            const raw = localStorage.getItem(GROUP_KEY);
            if(!raw) return { users: [], messages: [] };
            return JSON.parse(raw);
        }

        function saveDB(data) {
            localStorage.setItem(GROUP_KEY, JSON.stringify(data));
        }

        // --- REGISTER ---
        function register() {
            const name = document.getElementById('reg-name').value.trim();
            const pass = document.getElementById('reg-pass').value.trim();

            if(!name || !pass) return alert("Ism va parol kiritish shart!");

            const db = getDB();

            // Ism bandmi? (ID vazifasi)
            const exists = db.users.find(u => u.name.toLowerCase() === name.toLowerCase());
            if(exists) {
                return alert("Bu ism allaqachon band! Boshqa ism tanlang.");
            }

            const newUser = { name: name, password: pass };
            db.users.push(newUser);
            db.messages.push({
                id: Date.now(),
                type: 'system',
                text: `${name} chatga qo'shildi.`,
                time: new Date().toLocaleTimeString()
            });

            saveDB(db);
            currentUser = newUser;
            localStorage.setItem('glass_chat_last_user', name);
            
            enterChat();
        }

        // --- LOGIN ---
        function login() {
            const name = document.getElementById('login-name').value.trim();
            const pass = document.getElementById('login-pass').value.trim();

            const db = getDB();
            const user = db.users.find(u => u.name.toLowerCase() === name.toLowerCase());

            if(!user) return alert("Bunday foydalanuvchi topilmadi.");
            if(user.password !== pass) return alert("Parol noto'g'ri!");

            currentUser = user;
            localStorage.setItem('glass_chat_last_user', name);
            enterChat();
        }

        function enterChat() {
            document.getElementById('register-screen').classList.add('hidden');
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('chat-interface').classList.add('active');
            
            // Display Group ID (Shared key simulyatsiyasi)
            document.getElementById('group-id-display').innerText = "ID: " + GROUP_KEY;

            loadMessages();
        }

        // --- MESSAGING ---
        function loadMessages() {
            const db = getDB();
            messages = db.messages;
            renderMessages();
            renderUserList(db.users);
        }

        function sendMessage() {
            const input = document.getElementById('msg-input');
            const text = input.value.trim();
            if(!text) return;

            const db = getDB();

            const msgObj = {
                id: Date.now(),
                sender: currentUser.name,
                text: text,
                time: new Date().toLocaleTimeString(),
                to: privateTarget // null = hammasiga, string = shu odamga
            };

            db.messages.push(msgObj);
            saveDB(db);
            
            input.value = '';
            loadMessages(); // Refresh UI
        }

        function renderMessages() {
            const container = document.getElementById('msg-list');
            container.innerHTML = '';

            messages.forEach(msg => {
                // Shaxsiy xabar filteri
                // 1. Agar xabar umumiy bo'lsa (msg.to === null)
                // 2. Agar xabar men yuborgan bo'lsam
                // 3. Agar xabar menga yuborilgan bo'lsa
                
                let isVisible = false;
                if(msg.type === 'system') {
                    isVisible = true;
                } else {
                    if (msg.to === null) {
                        isVisible = true; // Umumiy
                    } else if (msg.to === currentUser.name) {
                        isVisible = true; // Menga kelgan
                    } else if (msg.sender === currentUser.name) {
                        isVisible = true; // Men yuborgan
                    }
                }

                if(!isVisible) return;

                const isMine = (msg.sender === currentUser.name);
                const div = document.createElement('div');
                div.className = `msg ${isMine ? 'mine' : 'others'}`;

                let extraInfo = '';
                if(msg.to && msg.to !== currentUser.name) {
                    extraInfo = `<span class="private-badge">Shaxsiy: ${msg.to}</span>`;
                } else if (msg.to && msg.to === currentUser.name && !isMine) {
                    extraInfo = `<span class="private-badge">Shaxsiy sizga</span>`;
                }

                const senderDisplay = msg.type === 'system' ? 'SYSTEM' : msg.sender;

                div.innerHTML = `
                    <span class="msg-meta">${senderDisplay} ${extraInfo}</span>
                    ${msg.text}
                    <div class="msg-time">${msg.time}</div>
                `;
                container.appendChild(div);
            });
            container.scrollTop = container.scrollHeight;
        }

        // --- USER LIST & PRIVATE CHAT ---
        function renderUserList(users) {
            const container = document.getElementById('users-container');
            container.innerHTML = '';

            // "Umumiy" varianti
            const allDiv = document.createElement('div');
            allDiv.className = 'user-item';
            allDiv.style.background = (privateTarget === null) ? 'rgba(0, 210, 255, 0.3)' : 'transparent';
            allDiv.innerHTML = `<span>üåê Hamma (Umumiy)</span>`;
            allDiv.onclick = () => selectUser(null);
            container.appendChild(allDiv);

            users.forEach(u => {
                if(u.name === currentUser.name) return; // O'zini ko'rsatmaslik

                const div = document.createElement('div');
                div.className = 'user-item';
                div.style.background = (privateTarget === u.name) ? 'rgba(0, 210, 255, 0.3)' : 'transparent';
                div.innerHTML = `<span>üë§ ${u.name}</span>`;
                div.onclick = () => selectUser(u.name);
                container.appendChild(div);
            });
        }

        function selectUser(name) {
            privateTarget = name;
            toggleUserList(); // Yopish
            
            const indicator = document.getElementById('mode-indicator');
            const input = document.getElementById('msg-input');
            
            if(name === null) {
                indicator.innerText = "Umumiy";
                indicator.style.background = "rgba(255,255,255,0.1)";
                input.placeholder = "Xabar yozing (hammaga)...";
            } else {
                indicator.innerText = `Shaxsiy: ${name}`;
                indicator.style.background = "#ff0055";
                input.placeholder = `${name} ga yozish...`;
            }
            
            // Xabarlarni qayta render qilish (filter uchun)
            renderMessages();
        }

        function toggleUserList() {
            document.getElementById('user-list-panel').classList.toggle('open');
        }

    </script>
</body>
</html>
